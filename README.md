# Smart Contract LLM Benchmark Pipeline

A comprehensive Python pipeline for benchmarking LLM-generated Solidity smart contracts with compilation, security analysis, and gas consumption measurements.

## ğŸ“‹ Overview

This project provides a complete pipeline for evaluating smart contracts generated by different LLMs:

1. **Contract Generation** - Generate contracts from prompts using Ollama LLMs
2. **Compilation & Security Analysis** - Compile contracts and run Slither security analysis  
3. **Gas Consumption Analysis** - Deploy contracts to local blockchain and measure gas usage

## ğŸ”§ Prerequisites

### Windows Users
- **WSL (Windows Subsystem for Linux)** - Gas analysis must run in WSL
- Python 3.8+ in WSL for gas analysis

### Python Environment
- Python 3.8+
- Virtual environment (recommended)

### Required Tools

#### For Contract Generation & Compilation (Steps 1-2)
```bash
# Windows or WSL
pip install pandas yaspin requests slither-analyzer solc-select python-dotenv
```

#### For Gas Analysis (Step 3) - WSL Only
```bash
# In WSL terminal
pip install web3 py-solc-x pandas

# Install Foundry (Anvil)
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

### OpenZeppelin Contracts
```bash
# In project root
npm init -y
npm install @openzeppelin/contracts
```

## ğŸ“ Project Structure

```
SC_generation/
â”œâ”€â”€ output/                          # Generated contracts and results
â”‚   â”œâ”€â”€ llama3.2_1b/
â”‚   â”‚   â”œâ”€â”€ Auction Contract/
â”‚   â”‚   â”‚   â”œâ”€â”€ 0.sol
â”‚   â”‚   â”‚   â”œâ”€â”€ 0.txt
â”‚   â”‚   â”‚   â””â”€â”€ 1.sol
â”‚   â”‚   â””â”€â”€ ERC20-Like Token/
â”‚   â”œâ”€â”€ generation_results.json      # Raw generation data
â”‚   â”œâ”€â”€ generation_summary.json      # Generation statistics + folder mapping
â”‚   â”œâ”€â”€ compilation_results.json     # Compilation + Slither results
â”‚   â”œâ”€â”€ final_analysis.json          # Complete analysis with gas data
â”‚   â”œâ”€â”€ detailed_summary.txt         # Human-readable report
â”‚   â”œâ”€â”€ quick_summary.txt            # Quick statistics
â”‚   â”œâ”€â”€ gas_consumption_results.csv  # Gas usage per contract
â”‚   â””â”€â”€ gas_consumption_analysis.json # Gas statistics
â”œâ”€â”€ node_modules/                    # OpenZeppelin contracts
â”œâ”€â”€ prompts_2nd.csv                  # Input prompts
â”œâ”€â”€ generate_contracts.py            # Step 1: Generate contracts
â”œâ”€â”€ compile_and_analyze.py           # Step 2: Compile & analyze
â”œâ”€â”€ gas_analyzer.py                  # Step 3: Gas consumption
â””â”€â”€ requirements.txt                 # Python dependencies
```

## ğŸš€ Complete Workflow

### Step 1: Generate Contracts

**Script:** `generate_contracts.py`  
**Environment:** Windows or WSL  
**Dependencies:** Ollama running locally

```bash
# Make sure Ollama is running
# Then run:
python generate_contracts.py
```

**Outputs:**
- `output/generation_results.json` - All generated contract data
- `output/generation_summary.json` - Statistics and folder mapping
- `output/<model>/<prompt>/*.sol` - Solidity files
- `output/<model>/<prompt>/*.txt` - Raw LLM responses

**Configuration in script:**
```python
NUM_ITERATIONS = 2
MODELS = [
    "llama3.2:1b",
    "gemma3:1b", 
    "deepseek-coder:1.3b"
]
```

### Step 2: Compile and Analyze Security

**Script:** `compile_and_analyze.py`  
**Environment:** Windows or WSL  
**Dependencies:** solc, slither, OpenZeppelin

```bash
# Install solc version
solc-select install 0.8.20
solc-select use 0.8.20

# Run compilation and analysis
python compile_and_analyze.py
```

**Outputs:**
- `output/compilation_results.json` - Full compilation + Slither data
- `output/final_analysis.json` - Statistical analysis
- `output/detailed_summary.txt` - Detailed vulnerability report
- `output/quick_summary.txt` - Quick statistics

**What it does:**
- Compiles each `.sol` file with OpenZeppelin support
- Runs Slither security analysis on compiled contracts
- Extracts and categorizes vulnerabilities (High/Medium/Low)
- Generates comprehensive statistics per model

### Step 3: Gas Consumption Analysis

**Script:** `gas_analyzer.py`  
**Environment:** **WSL Only** (requires Anvil)  
**Dependencies:** web3, py-solc-x, Anvil

```bash
# In WSL terminal
source venv/bin/activate  # If using virtual environment

# Run gas analysis
python3 gas_analyzer.py
```

**Outputs:**
- `output/gas_consumption_results.csv` - Gas usage per contract
- `output/gas_consumption_analysis.json` - Gas statistics
- Updates `output/final_analysis.json` with gas data

**What it does:**
- Starts local Anvil blockchain
- Only processes successfully compiled contracts
- Deploys each contract and measures gas consumption
- Generates constructor arguments automatically
- Times out after 30 seconds per deployment

## ğŸ“Š Output Files Explained

### generation_results.json
```json
{
  "llama3.2:1b": {
    "Auction Contract": {
      "iteration_0": {
        "response": "...",
        "solidity_code": "...",
        "timing": {"generation_seconds": 15.2}
      }
    }
  }
}
```

### compilation_results.json
```json
{
  "llama3.2:1b": {
    "Auction Contract": {
      "iteration_0": {
        "generation": {...},
        "compilation": {
          "success": true,
          "stdout": "...",
          "stderr": "..."
        },
        "slither": {
          "stdout": "...",
          "stderr": "..."
        }
      }
    }
  }
}
```

### final_analysis.json
```json
{
  "statistics": {
    "llama3.2:1b": {
      "compilation": {
        "successful": 45,
        "success_rate": 90.0
      },
      "vulnerabilities": {
        "High": 5,
        "Medium": 12,
        "Low": 8
      },
      "gas_consumption": {
        "deployment_success": 42,
        "gas_statistics": {
          "average": 450234,
          "min": 180500,
          "max": 950000
        }
      }
    }
  }
}
```

### gas_consumption_results.csv
```csv
model,contract_type,file_name,deployment_success,gas_used
llama3.2:1b,Auction Contract,0.sol,True,450234
llama3.2:1b,Auction Contract,1.sol,False,
```

## âš™ï¸ Configuration

### Modify Models and Iterations

**File:** `generate_contracts.py`
```python
NUM_ITERATIONS = 5  # Number of contracts per prompt
MODELS = [
    "your-model-1",
    "your-model-2"
]
```

### Adjust Timeouts

**File:** `compile_and_analyze.py`
```python
# Compilation timeout
timeout=30  # seconds

# Slither timeout  
timeout=60  # seconds
```

**File:** `gas_analyzer.py`
```python
# Deployment timeout
timeout=30  # seconds

# HTTP timeout
request_kwargs={'timeout': 60}
```

### Change Solidity Version

**File:** `compile_and_analyze.py`
```bash
# Before running
solc-select install 0.8.19
solc-select use 0.8.19
```

**File:** `gas_analyzer.py`
```python
solc_version = '0.8.19'  # Line ~115
```

## ğŸ› ï¸ Troubleshooting

### "Anvil not found"
```bash
# In WSL
curl -L https://foundry.paradigm.xyz | bash
foundryup
anvil --version
```

### "solc not found"
```bash
pip install solc-select
solc-select install 0.8.20
solc-select use 0.8.20
solc --version
```

### "OpenZeppelin imports fail"
```bash
# Verify installation
ls node_modules/@openzeppelin/contracts

# Reinstall if needed
npm install @openzeppelin/contracts
```

### "subprocess output is empty"
This is a virtual environment issue. Recreate your venv:
```bash
rmdir /s .venv  # Windows
rm -rf .venv    # WSL

python -m venv .venv
.venv\Scripts\activate  # Windows
source .venv/bin/activate  # WSL

pip install -r requirements.txt
```

### Gas analysis in Windows
Gas analysis **must run in WSL**. Anvil is not fully supported in Windows PowerShell/CMD.

## ğŸ“ˆ Running the Complete Pipeline

### Option 1: Run all steps sequentially

**Windows/WSL:**
```bash
# Step 1: Generate
python generate_contracts.py

# Step 2: Compile & Analyze
python compile_and_analyze.py
```

**WSL Only:**
```bash
# Step 3: Gas Analysis
python3 gas_analyzer.py
```

### Option 2: Create a master script

**File:** `run_pipeline.sh` (WSL only)
```bash
#!/bin/bash

echo "Step 1: Generating contracts..."
python3 generate_contracts.py

echo "Step 2: Compiling and analyzing..."
python3 compile_and_analyze.py

echo "Step 3: Analyzing gas consumption..."
python3 gas_analyzer.py

echo "Pipeline complete!"
```

```bash
chmod +x run_pipeline.sh
./run_pipeline.sh
```

## ğŸ“‹ Requirements Files

### requirements.txt (Steps 1-2)
```txt
pandas
yaspin
requests
slither-analyzer
solc-select
python-dotenv
```

### requirements_gas.txt (Step 3 - WSL)
```txt
web3>=6.0.0
py-solc-x>=2.0.0
pandas>=2.0.0
```

## ğŸ” Understanding the Results

### Compilation Success Rate
Percentage of generated contracts that compile without errors.

### Vulnerability Analysis
- **High**: Critical security issues (reentrancy, unprotected functions)
- **Medium**: Important issues (unchecked calls, dangerous patterns)
- **Low**: Minor issues (naming conventions, missing events)
- **Informational**: Code quality suggestions
- **Optimization**: Gas optimization opportunities

### Clean Contracts
Contracts with only Informational/Optimization issues (no security vulnerabilities).

### Gas Consumption
- **Average**: Mean gas used for deployment
- **Min/Max**: Range of gas consumption
- **Median**: Middle value (more robust than average)

## ğŸ¤ Contributing

To add new analysis metrics:
1. Generate contracts with `generate_contracts.py`
2. Add analysis logic to `compile_and_analyze.py` or create new script
3. Read from `compilation_results.json` or other output files
4. Add new metrics to `final_analysis.json`

## ğŸ“„ License

This project is for research purposes.

## ğŸ“§ Support

Common issues:
1. Check you're in the correct environment (Windows vs WSL)
2. Verify all dependencies are installed
3. Ensure virtual environment is activated
4. Check that Ollama/Anvil is running for respective steps

---

**Remember**: 
- Steps 1-2 can run in Windows or WSL
- Step 3 (gas analysis) **must run in WSL**
- Always activate your virtual environment before running scripts